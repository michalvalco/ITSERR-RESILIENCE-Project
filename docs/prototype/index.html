<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ITSERR-RESILIENCE — Corpus Browser</title>
  <style>
/* =============================================================================
   ITSERR-RESILIENCE Corpus Browser — Styles
   Inspired by the GNORM project interface (University of Palermo)
   ============================================================================= */

:root {
  --sidebar-bg: #1a1f36;
  --sidebar-hover: #252b48;
  --sidebar-active: #303a5c;
  --sidebar-text: #b0b7d1;
  --sidebar-text-active: #ffffff;
  --sidebar-width: 300px;
  --main-bg: #f8f9fa;
  --content-bg: #ffffff;
  --text-color: #2d3436;
  --text-muted: #636e72;
  --border-color: #dee2e6;
  --biblical: #2196F3;
  --patristic: #9C27B0;
  --reformation: #FF9800;
  --classical: #607D8B;
  --confessional: #4CAF50;
  --factual: #4CAF50;
  --interpretive: #FF9800;
  --deferred: #F44336;
  --accent: #3f51b5;
  --accent-light: #7986cb;
  --radius: 6px;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 24px rgba(0,0,0,0.12);
  --right-panel-width: 360px;
  --right-panel-transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
  font-size: 15px;
  line-height: 1.6;
  color: var(--text-color);
  background: var(--main-bg);
}

.app { display: flex; height: 100vh; overflow: hidden; }

/* Sidebar */
.sidebar {
  width: var(--sidebar-width); min-width: var(--sidebar-width);
  background: var(--sidebar-bg); color: var(--sidebar-text);
  display: flex; flex-direction: column; overflow: hidden; z-index: 10;
}
.sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
.sidebar-header h1 {
  font-size: 14px; font-weight: 600; color: var(--sidebar-text-active);
  letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 4px;
}
.sidebar-header .subtitle { font-size: 11px; color: var(--sidebar-text); opacity: 0.7; }
.sidebar-nav { flex: 1; overflow-y: auto; padding: 8px 0; }
.sidebar-nav::-webkit-scrollbar { width: 4px; }
.sidebar-nav::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }

.chapter-group { margin-bottom: 2px; }
.chapter-item {
  display: flex; align-items: center; padding: 8px 16px 8px 20px;
  cursor: pointer; transition: background 0.15s; font-size: 13px;
  user-select: none; gap: 8px;
}
.chapter-item:hover { background: var(--sidebar-hover); }
.chapter-item.active { background: var(--sidebar-active); color: var(--sidebar-text-active); }
.chapter-item .expand-icon {
  width: 16px; height: 16px; font-size: 10px;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.2s; opacity: 0.5; flex-shrink: 0;
}
.chapter-item.expanded .expand-icon { transform: rotate(90deg); }
.chapter-item .chapter-title { flex: 1; font-weight: 500; }
.chapter-item .chapter-meta { font-size: 10px; opacity: 0.5; flex-shrink: 0; }

.page-list { display: none; padding-left: 44px; }
.page-list.visible { display: block; }
.page-item { padding: 4px 16px 4px 0; font-size: 12px; cursor: pointer; transition: color 0.15s; opacity: 0.6; }
.page-item:hover { opacity: 1; color: var(--sidebar-text-active); }
.page-item.active { opacity: 1; color: var(--accent-light); }

.sidebar-footer { padding: 12px 20px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 10px; opacity: 0.4; }

/* Main content */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

.topbar {
  display: flex; align-items: center; padding: 12px 24px;
  background: var(--content-bg); border-bottom: 1px solid var(--border-color);
  gap: 16px; flex-shrink: 0;
}
.search-box { flex: 1; max-width: 480px; position: relative; }
.search-box input {
  width: 100%; padding: 8px 12px 8px 36px;
  border: 1px solid var(--border-color); border-radius: var(--radius);
  font-size: 13px; outline: none;
  transition: border-color 0.15s, box-shadow 0.15s; background: var(--main-bg);
}
.search-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(63,81,181,0.12); }
.search-box .search-icon {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  color: var(--text-muted); font-size: 14px;
}
.search-results-count { font-size: 12px; color: var(--text-muted); white-space: nowrap; }

.filter-bar {
  display: flex; align-items: center; padding: 8px 24px;
  background: var(--content-bg); border-bottom: 1px solid var(--border-color);
  gap: 8px; flex-shrink: 0; flex-wrap: wrap;
}
.filter-bar .filter-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-right: 4px; }
.filter-tag {
  display: inline-flex; align-items: center; padding: 3px 10px;
  border-radius: 12px; font-size: 11px; font-weight: 500;
  cursor: pointer; transition: opacity 0.15s; gap: 4px; user-select: none;
}
.filter-tag .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.filter-tag.active { opacity: 1; }
.filter-tag:not(.active) { opacity: 0.35; }

.filter-tag[data-type="biblical"] { background: rgba(33,150,243,0.12); color: var(--biblical); }
.filter-tag[data-type="biblical"] .dot { background: var(--biblical); }
.filter-tag[data-type="patristic"] { background: rgba(156,39,176,0.12); color: var(--patristic); }
.filter-tag[data-type="patristic"] .dot { background: var(--patristic); }
.filter-tag[data-type="reformation"] { background: rgba(255,152,0,0.12); color: var(--reformation); }
.filter-tag[data-type="reformation"] .dot { background: var(--reformation); }
.filter-tag[data-type="classical"] { background: rgba(96,125,139,0.12); color: var(--classical); }
.filter-tag[data-type="classical"] .dot { background: var(--classical); }
.filter-tag[data-type="confessional"] { background: rgba(76,175,80,0.12); color: var(--confessional); }
.filter-tag[data-type="confessional"] .dot { background: var(--confessional); }

.filter-separator { width: 1px; height: 20px; background: var(--border-color); margin: 0 4px; }

.filter-tag.epistemic[data-epistemic="FACTUAL"] { background: rgba(76,175,80,0.12); color: var(--factual); }
.filter-tag.epistemic[data-epistemic="FACTUAL"] .dot { background: var(--factual); }
.filter-tag.epistemic[data-epistemic="INTERPRETIVE"] { background: rgba(255,152,0,0.12); color: var(--interpretive); }
.filter-tag.epistemic[data-epistemic="INTERPRETIVE"] .dot { background: var(--interpretive); }

.content-area { flex: 1; overflow-y: auto; padding: 24px; }
.content-area::-webkit-scrollbar { width: 8px; }
.content-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

.info-banner {
  background: linear-gradient(135deg, #e8eaf6, #e3f2fd);
  border: 1px solid #c5cae9; border-radius: var(--radius);
  padding: 16px 20px; margin-bottom: 24px; font-size: 13px; line-height: 1.6;
}
.info-banner h2 { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--accent); }
.info-banner p { margin-bottom: 6px; color: var(--text-muted); }
.info-banner .badge {
  display: inline-block; padding: 2px 8px; border-radius: 3px;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.5px; background: rgba(63,81,181,0.1); color: var(--accent);
}

.chapter-header { margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid var(--accent); }
.chapter-header h2 { font-size: 20px; font-weight: 700; color: var(--accent); margin-bottom: 2px; }
.chapter-header .chapter-en { font-size: 14px; color: var(--text-muted); font-style: italic; }
.chapter-header .chapter-stats { margin-top: 8px; display: flex; gap: 12px; font-size: 11px; }
.chapter-header .stat { display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
.chapter-header .stat .dot { width: 6px; height: 6px; border-radius: 50%; }

.page-block { margin-bottom: 24px; }
.page-label {
  font-size: 11px; font-weight: 600; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;
  display: flex; align-items: center; gap: 8px;
}
.page-label::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }

.text-content {
  background: var(--content-bg); border: 1px solid var(--border-color);
  border-radius: var(--radius); padding: 20px 24px; box-shadow: var(--shadow);
  font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
  font-size: 15px; line-height: 1.8; color: #333; white-space: normal; word-wrap: break-word;
  text-align: justify; hyphens: auto; -webkit-hyphens: auto;
}

.ref-highlight { padding: 1px 4px; border-radius: 3px; cursor: pointer; transition: background-color 0.15s; position: relative; }
.ref-highlight:hover { filter: brightness(0.92); }
.ref-highlight[data-type="biblical"] { background: rgba(33,150,243,0.15); border-bottom: 2px solid var(--biblical); }
.ref-highlight[data-type="patristic"] { background: rgba(156,39,176,0.15); border-bottom: 2px solid var(--patristic); }
.ref-highlight[data-type="reformation"] { background: rgba(255,152,0,0.15); border-bottom: 2px solid var(--reformation); }
.ref-highlight[data-type="classical"] { background: rgba(96,125,139,0.15); border-bottom: 2px solid var(--classical); }
.ref-highlight[data-type="confessional"] { background: rgba(76,175,80,0.15); border-bottom: 2px solid var(--confessional); }

.search-highlight { background: rgba(255,235,59,0.5); border-radius: 2px; padding: 0 1px; }

.ref-tooltip {
  display: none; position: fixed; background: var(--sidebar-bg);
  color: var(--sidebar-text-active); padding: 10px 14px; border-radius: var(--radius);
  font-size: 12px; font-family: 'Segoe UI', -apple-system, sans-serif;
  line-height: 1.5; box-shadow: var(--shadow-lg); z-index: 1000; max-width: 280px; pointer-events: none;
}
.ref-tooltip.visible { display: block; }
.ref-tooltip .tooltip-type { font-weight: 600; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; margin-bottom: 4px; }
.ref-tooltip .tooltip-text { font-style: italic; margin-bottom: 4px; opacity: 0.9; }
.ref-tooltip .tooltip-meta { display: flex; gap: 8px; margin-top: 6px; }
.ref-tooltip .tooltip-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; text-transform: uppercase; }
.ref-tooltip .tooltip-badge.factual { background: rgba(76,175,80,0.2); color: #81c784; }
.ref-tooltip .tooltip-badge.interpretive { background: rgba(255,152,0,0.2); color: #ffb74d; }
.ref-tooltip .tooltip-badge.deferred { background: rgba(244,67,54,0.2); color: #e57373; }
.ref-tooltip .tooltip-badge.consensus { background: rgba(33,150,243,0.2); color: #64b5f6; }
.consensus-badge {
  display: inline-block; padding: 1px 6px; border-radius: 3px;
  font-size: 9px; font-weight: 600; text-transform: uppercase;
  background: rgba(33,150,243,0.15); color: var(--biblical); letter-spacing: 0.3px;
}
.method-tag {
  display: inline-block; padding: 1px 5px; border-radius: 3px;
  font-size: 9px; font-weight: 500; background: rgba(0,0,0,0.06);
  color: var(--text-muted); margin-right: 3px;
}
.ref-highlight.consensus-highlight { box-shadow: 0 0 0 1.5px var(--biblical); }

.stats-panel { padding: 12px 20px; border-top: 1px solid rgba(255,255,255,0.08); }
.stats-panel h3 { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; opacity: 0.5; }
.stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; padding: 2px 0; }
.stat-row .stat-label { display: flex; align-items: center; gap: 6px; }
.stat-row .stat-dot { width: 6px; height: 6px; border-radius: 50%; }
.stat-row .stat-value { font-weight: 600; color: var(--sidebar-text-active); }

.welcome-screen {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 100%; text-align: center; padding: 40px;
}
.welcome-screen h2 { font-size: 24px; font-weight: 300; color: var(--text-muted); margin-bottom: 8px; }
.welcome-screen p { font-size: 14px; color: var(--text-muted); max-width: 500px; margin-bottom: 20px; }

.no-results { text-align: center; padding: 40px; color: var(--text-muted); }

/* Sidebar toggle button (hidden on wide screens) */
.sidebar-toggle {
  display: none; background: none; border: 1px solid var(--border-color);
  border-radius: var(--radius); width: 36px; height: 36px; font-size: 18px;
  cursor: pointer; color: var(--text-muted); align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s; flex-shrink: 0;
}
.sidebar-toggle:hover { background: var(--main-bg); color: var(--text-color); }
.sidebar-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
  z-index: 9; opacity: 0; transition: opacity 0.3s;
}
.sidebar-overlay.visible { display: block; opacity: 1; }

@media (max-width: 1100px) { :root { --right-panel-width: 300px; } }
@media (max-width: 900px) {
  .right-panel.open { width: var(--right-panel-width); min-width: 0; }
  .right-panel-header { min-width: 0; }
  .right-panel-body { min-width: 0; }
}
@media (max-width: 768px) {
  .sidebar {
    position: fixed; top: 0; left: 0; height: 100vh; z-index: 11;
    transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar.mobile-open { transform: translateX(0); }
  .sidebar-toggle { display: flex; }
  .topbar { padding: 10px 16px; }
  .content-area { padding: 16px; }
  .text-content { padding: 16px; font-size: 14px; }
  .right-panel { position: fixed; top: 0; right: 0; height: 100vh; z-index: 20; box-shadow: var(--shadow-lg); }
  .right-panel.open { width: 85vw; min-width: 0; max-width: 360px; }
  .right-panel-header { min-width: 0; }
  .right-panel-body { min-width: 0; }
  .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
}

.loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); }
.loading .spinner {
  width: 32px; height: 32px; border: 3px solid var(--border-color);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin-bottom: 12px;
}
.loading .loading-text { font-size: 13px; margin-bottom: 8px; }
.loading .progress-bar-container {
  width: 220px; height: 4px; background: var(--border-color);
  border-radius: 2px; overflow: hidden;
}
.loading .progress-bar {
  height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-light));
  border-radius: 2px; transition: width 0.4s ease;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Export button */
.export-btn {
  display: inline-flex; align-items: center; gap: 6px;
  background: none; border: 1px solid var(--border-color); border-radius: var(--radius);
  padding: 6px 14px; font-size: 12px; cursor: pointer; color: var(--text-muted);
  transition: background 0.15s, color 0.15s, border-color 0.15s; white-space: nowrap;
}
.export-btn:hover { background: var(--main-bg); color: var(--text-color); border-color: var(--accent); }
.export-btn svg { width: 14px; height: 14px; }
.export-dropdown {
  position: absolute; top: calc(100% + 4px); right: 0; background: var(--content-bg);
  border: 1px solid var(--border-color); border-radius: var(--radius);
  box-shadow: var(--shadow-lg); z-index: 100; min-width: 180px; display: none;
  overflow: hidden;
}
.export-dropdown.visible { display: block; }
.export-dropdown-item {
  display: block; width: 100%; padding: 10px 16px; border: none; background: none;
  text-align: left; font-size: 13px; cursor: pointer; color: var(--text-color);
  transition: background 0.15s;
}
.export-dropdown-item:hover { background: var(--main-bg); }
.export-dropdown-item .export-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

/* Pipeline status indicator */
.pipeline-status {
  display: flex; gap: 0; margin-top: 12px; border-radius: var(--radius); overflow: hidden;
  border: 1px solid var(--border-color); background: var(--main-bg);
}
.pipeline-stage {
  flex: 1; padding: 8px 6px; text-align: center; font-size: 10px; font-weight: 500;
  text-transform: uppercase; letter-spacing: 0.3px; position: relative;
  transition: background 0.2s, color 0.2s; line-height: 1.3;
}
.pipeline-stage.active {
  background: linear-gradient(135deg, rgba(76,175,80,0.15), rgba(76,175,80,0.08));
  color: #2e7d32;
}
.pipeline-stage.pending {
  background: transparent; color: var(--text-muted); opacity: 0.5;
}
.pipeline-stage .stage-icon { font-size: 14px; display: block; margin-bottom: 2px; }
.pipeline-stage + .pipeline-stage { border-left: 1px solid var(--border-color); }

/* CRF notice banner */
.crf-notice {
  display: flex; align-items: flex-start; gap: 10px;
  background: linear-gradient(135deg, #fff3e0, #fff8e1);
  border: 1px solid #ffe0b2; border-left: 4px solid #ff9800;
  border-radius: var(--radius); padding: 12px 16px; margin-top: 12px;
  font-size: 12px; line-height: 1.5; color: #5d4037;
}
.crf-notice .notice-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
.crf-notice strong { color: #e65100; }

/* Keyboard shortcuts overlay */
.shortcuts-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 1000; align-items: center; justify-content: center;
}
.shortcuts-overlay.visible { display: flex; }
.shortcuts-panel {
  background: var(--content-bg); border-radius: 12px; padding: 28px 32px;
  box-shadow: var(--shadow-lg); max-width: 420px; width: 90%;
}
.shortcuts-panel h3 {
  font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--accent);
  display: flex; align-items: center; justify-content: space-between;
}
.shortcuts-panel .close-shortcuts {
  background: none; border: none; font-size: 20px; cursor: pointer;
  color: var(--text-muted); padding: 0 4px;
}
.shortcut-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 6px 0; font-size: 13px; color: var(--text-color);
}
.shortcut-row + .shortcut-row { border-top: 1px solid var(--border-color); }
.shortcut-key {
  display: inline-block; padding: 2px 8px; background: var(--main-bg);
  border: 1px solid var(--border-color); border-radius: 4px;
  font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; font-size: 12px;
  color: var(--text-muted); min-width: 28px; text-align: center;
}

/* Help button */
.help-btn {
  background: none; border: 1px solid var(--border-color); border-radius: 50%;
  width: 28px; height: 28px; font-size: 14px; cursor: pointer;
  color: var(--text-muted); display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s; flex-shrink: 0; font-weight: 600;
}
.help-btn:hover { background: var(--main-bg); color: var(--text-color); }

/* Back to dashboard button */
.back-to-dashboard {
  background: none; border: none; cursor: pointer; color: var(--accent);
  font-size: 12px; display: flex; align-items: center; gap: 4px;
  padding: 0; transition: opacity 0.15s; white-space: nowrap;
}
.back-to-dashboard:hover { opacity: 0.7; }

/* Dashboard */
.dashboard { display: grid; gap: 20px; margin-top: 20px; }
.dashboard-stats {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px;
}
.stat-card {
  background: var(--content-bg); border: 1px solid var(--border-color);
  border-radius: var(--radius); padding: 16px 12px; text-align: center;
  box-shadow: var(--shadow); transition: transform 0.15s, box-shadow 0.15s;
}
.stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.stat-card .stat-number { font-size: 28px; font-weight: 700; line-height: 1.2; }
.stat-card .stat-desc {
  font-size: 10px; color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 0.5px; margin-top: 4px;
}

.dashboard-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 900px) { .dashboard-charts { grid-template-columns: 1fr; } }

.chart-panel {
  background: var(--content-bg); border: 1px solid var(--border-color);
  border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow);
}
.chart-panel.full-width { grid-column: 1 / -1; }
.chart-panel h3 {
  font-size: 12px; font-weight: 600; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;
}

/* Horizontal bar chart */
.bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.bar-label {
  font-size: 12px; width: 130px; text-align: right; color: var(--text-color);
  flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.bar-track { flex: 1; height: 22px; background: var(--main-bg); border-radius: 4px; overflow: hidden; }
.bar-fill {
  height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  min-width: 2px;
}
.bar-value { font-size: 12px; font-weight: 600; width: 28px; color: var(--text-color); text-align: right; }

/* Chapter density heatmap */
.heatmap-row {
  display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
  cursor: pointer; padding: 5px 4px; border-radius: 4px; transition: background 0.15s;
}
.heatmap-row:hover { background: rgba(63,81,181,0.06); }
.heatmap-label {
  font-size: 11px; width: 170px; text-align: right; color: var(--text-muted);
  flex-shrink: 0; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.heatmap-track {
  flex: 1; height: 22px; background: var(--main-bg); border-radius: 4px;
  overflow: hidden; display: flex;
}
.heatmap-segment { height: 100%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
.heatmap-total {
  font-size: 11px; font-weight: 600; width: 24px; color: var(--text-muted); text-align: right;
}
.heatmap-empty { font-size: 10px; color: var(--text-muted); opacity: 0.4; padding: 0 8px; line-height: 22px; }

/* Legend */
.chart-legend { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border-color); }
.legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-muted); }
.legend-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }

/* Right context panel */
.right-panel {
  width: 0; min-width: 0; overflow: hidden;
  background: var(--content-bg); display: flex; flex-direction: column;
  border-left: 0px solid var(--border-color); flex-shrink: 0;
  transition: width var(--right-panel-transition), min-width var(--right-panel-transition),
              border-left-width var(--right-panel-transition);
}
.right-panel.open { width: var(--right-panel-width); min-width: var(--right-panel-width); border-left-width: 1px; }

.right-panel-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; border-bottom: 1px solid var(--border-color); flex-shrink: 0;
  min-width: var(--right-panel-width);
}
.right-panel-title {
  font-size: 12px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.5px; color: var(--text-muted); white-space: nowrap;
}
.right-panel-close {
  background: none; border: 1px solid var(--border-color); border-radius: var(--radius);
  width: 28px; height: 28px; font-size: 16px; cursor: pointer;
  color: var(--text-muted); display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s; flex-shrink: 0;
}
.right-panel-close:hover { background: var(--main-bg); color: var(--text-color); }

.right-panel-body {
  flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px;
  min-width: var(--right-panel-width);
}
.right-panel-body::-webkit-scrollbar { width: 6px; }
.right-panel-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

/* Right panel toggle button */
.right-panel-toggle {
  background: none; border: 1px solid var(--border-color); border-radius: var(--radius);
  padding: 6px 12px; font-size: 12px; cursor: pointer; color: var(--text-muted);
  transition: background 0.15s, color 0.15s; white-space: nowrap;
}
.right-panel-toggle:hover { background: var(--main-bg); color: var(--text-color); }

/* Right panel content components */
.rp-section-title {
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.5px; margin-bottom: 8px; color: var(--text-muted);
}
.rp-ref-text {
  font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
  font-style: italic; font-size: 14px; line-height: 1.6; padding: 12px;
  background: var(--main-bg); border-radius: var(--radius);
  border-left: 3px solid var(--accent); margin-bottom: 12px;
}
.rp-meta { font-size: 12px; color: var(--text-muted); }
.rp-meta dt { font-weight: 600; margin-top: 8px; }
.rp-meta dd { margin-left: 0; margin-bottom: 4px; }
.rp-list { list-style: none; padding: 0; }
.rp-list-item {
  padding: 8px 10px; margin-bottom: 4px; border-radius: var(--radius);
  font-size: 12px; cursor: pointer; transition: background 0.15s;
  border-left: 3px solid transparent;
}
.rp-list-item:hover { background: var(--main-bg); }
.rp-search-chapter { padding: 10px 0; border-bottom: 1px solid var(--border-color); cursor: pointer; }
.rp-search-chapter:hover { background: var(--main-bg); margin: 0 -16px; padding: 10px 16px; }
.rp-search-chapter-title { font-size: 13px; font-weight: 600; }
.rp-search-chapter-count { font-size: 11px; color: var(--text-muted); }
.rp-search-snippet { font-size: 12px; color: var(--text-muted); margin-top: 4px; line-height: 1.5; max-height: 3em; overflow: hidden; }
.rp-stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; padding: 4px 0; }
.rp-stat-row .dot { width: 8px; height: 8px; border-radius: 50%; }
  </style>
</head>
<body>
  <div class="app">

    <!-- Sidebar overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1>St&ouml;ckel Corpus</h1>
        <div class="subtitle">Annotationes in Locos communes (1561)</div>
      </div>

      <nav class="sidebar-nav">
        <div class="loading">
          <div class="spinner"></div>
          <span class="loading-text">Loading...</span>
        </div>
      </nav>

      <div class="stats-panel"></div>

      <div class="sidebar-footer">
        ITSERR-RESILIENCE Project<br>
        TNA Fellowship 2026 &mdash; Layer 1 Prototype
      </div>
    </aside>

    <!-- Main content -->
    <main class="main">
      <!-- Top bar with search -->
      <div class="topbar">
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Open navigation" title="Open navigation">&#9776;</button>
        <button class="back-to-dashboard" id="backToDashboard" style="display:none;" aria-label="Back to dashboard" title="Back to dashboard">&#8592; Dashboard</button>
        <div class="search-box">
          <span class="search-icon">&#128269;</span>
          <input type="text" placeholder="Search the corpus (e.g. Paulus, peccatum, Deus)..." />
        </div>
        <span class="search-results-count"></span>
        <div style="position:relative;" id="exportContainer">
          <button class="export-btn" id="exportBtn" aria-label="Export references" title="Export references" style="display:none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export
          </button>
          <div class="export-dropdown" id="exportDropdown">
            <button class="export-dropdown-item" data-format="csv">
              <div>Export as CSV</div>
              <div class="export-desc">All references with type, confidence, location</div>
            </button>
            <button class="export-dropdown-item" data-format="json">
              <div>Export as JSON</div>
              <div class="export-desc">Full reference data with metadata</div>
            </button>
            <button class="export-dropdown-item" data-format="chapter-csv">
              <div>Current chapter (CSV)</div>
              <div class="export-desc">References from the active chapter only</div>
            </button>
          </div>
        </div>
        <button class="right-panel-toggle" id="rightPanelToggle" aria-label="Toggle details panel" title="Toggle details panel" style="display:none;">&#9776; Details</button>
        <button class="help-btn" id="helpBtn" aria-label="Keyboard shortcuts" title="Keyboard shortcuts (?)">&quest;</button>
      </div>

      <!-- Filter bar -->
      <div class="filter-bar">
        <span class="filter-label">Loading filters...</span>
      </div>

      <!-- Content -->
      <div class="content-area">
        <div class="loading" id="mainLoading">
          <div class="spinner"></div>
          <span class="loading-text">Loading corpus data...</span>
          <div class="progress-bar-container">
            <div class="progress-bar" id="loadingProgress"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Right context panel -->
    <aside class="right-panel" id="rightPanel">
      <div class="right-panel-header">
        <span class="right-panel-title">Details</span>
        <button class="right-panel-close" id="rightPanelClose" aria-label="Close panel" title="Close panel">&times;</button>
      </div>
      <div class="right-panel-body" id="rightPanelBody"></div>
    </aside>

  </div>

  <!-- Tooltip -->
  <div class="ref-tooltip"></div>

  <!-- Keyboard shortcuts overlay -->
  <div class="shortcuts-overlay" id="shortcutsOverlay">
    <div class="shortcuts-panel">
      <h3>
        Keyboard Shortcuts
        <button class="close-shortcuts" id="closeShortcuts" aria-label="Close">&times;</button>
      </h3>
      <div class="shortcut-row"><span>Search corpus</span><span class="shortcut-key">/</span></div>
      <div class="shortcut-row"><span>Back to dashboard</span><span class="shortcut-key">Home</span></div>
      <div class="shortcut-row"><span>Next chapter</span><span class="shortcut-key">&#8594;</span></div>
      <div class="shortcut-row"><span>Previous chapter</span><span class="shortcut-key">&#8592;</span></div>
      <div class="shortcut-row"><span>Toggle details panel</span><span class="shortcut-key">D</span></div>
      <div class="shortcut-row"><span>Close panel / overlay</span><span class="shortcut-key">Esc</span></div>
      <div class="shortcut-row"><span>Show this help</span><span class="shortcut-key">?</span></div>
    </div>
  </div>

  <script>
/* =============================================================================
   ITSERR-RESILIENCE Corpus Browser — Application Logic
   ============================================================================= */

(function () {
  'use strict';

  // State
  let corpus = null;
  let activeChapterId = null;
  let activeFilters = new Set(['biblical', 'patristic', 'reformation', 'classical', 'confessional']);
  let activeEpistemicFilters = new Set(['FACTUAL', 'INTERPRETIVE']);
  let searchQuery = '';

  // Right panel state
  let rightPanelState = { open: false, context: null, data: null, dismissedByUser: false };

  // DOM references (assigned after DOMContentLoaded)
  let sidebarNav, contentArea, searchInput, searchCount, tooltip;
  let rightPanel, rightPanelBody, rightPanelTitle, rightPanelToggle;
  let exportBtn, exportDropdown, backToDashboard;
  let sidebarEl, sidebarOverlay, sidebarToggle;
  let shortcutsOverlay;
  let loadingProgress;

  // ============================================================================
  // DATA LOADING (with progress indicator)
  // ============================================================================

  async function loadCorpus() {
    try {
      updateProgress(10, 'Fetching corpus data...');
      const resp = await fetch('data/corpus.json');
      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      updateProgress(40, 'Parsing corpus...');

      // Use streaming reader for progress on large files
      var contentLength = resp.headers.get('Content-Length');
      if (contentLength && parseInt(contentLength) > 100000) {
        var reader = resp.body.getReader();
        var received = 0;
        var total = parseInt(contentLength);
        var chunks = [];
        while (true) {
          var result = await reader.read();
          if (result.done) break;
          chunks.push(result.value);
          received += result.value.length;
          var pct = 40 + Math.round((received / total) * 40);
          updateProgress(pct, 'Loading ' + Math.round(received / 1024) + ' KB...');
        }
        var decoder = new TextDecoder();
        var text = chunks.map(function(c) { return decoder.decode(c, {stream: true}); }).join('');
        text += decoder.decode();
        updateProgress(85, 'Parsing JSON...');
        corpus = JSON.parse(text);
      } else {
        updateProgress(60, 'Parsing JSON...');
        corpus = await resp.json();
      }

      updateProgress(95, 'Initializing interface...');
      init();
      updateProgress(100, 'Ready');
    } catch (err) {
      contentArea.innerHTML =
        '<div class="no-results">' +
          '<h3>Failed to load corpus data</h3>' +
          '<p>' + escapeHtml(err.message) + '</p>' +
          '<p style="margin-top:12px;font-size:12px;">Make sure <code>data/corpus.json</code> exists. Run <code>build_corpus_json.py</code> to generate it.</p>' +
        '</div>';
    }
  }

  function updateProgress(pct, text) {
    if (loadingProgress) loadingProgress.style.width = pct + '%';
    var loadingText = document.querySelector('#mainLoading .loading-text');
    if (loadingText && text) loadingText.textContent = text;
  }

  // ============================================================================
  // INITIALIZATION
  // ============================================================================

  function init() {
    renderSidebar();
    renderStats();
    renderFilters();
    exportBtn.style.display = '';
    renderWelcome();
    bindEvents();
    handleHashNavigation();
  }

  // ============================================================================
  // SIDEBAR
  // ============================================================================

  function renderSidebar() {
    let html = '';
    for (let i = 0; i < corpus.chapters.length; i++) {
      let ch = corpus.chapters[i];
      let pageRange = 'pp. ' + ch.start_page + '\u2013' + ch.end_page;

      html += '<div class="chapter-group" data-chapter="' + escapeAttr(ch.id) + '">' +
        '<div class="chapter-item" data-chapter="' + escapeAttr(ch.id) + '">' +
          '<span class="expand-icon">&#9654;</span>' +
          '<span class="chapter-title">' + escapeHtml(ch.title) + '</span>' +
          '<span class="chapter-meta">' + escapeHtml(pageRange) + '</span>' +
        '</div>' +
        '<div class="page-list">';

      for (let j = 0; j < ch.pages.length; j++) {
        let pg = ch.pages[j];
        let pgRefs = pg.references.length;
        let refBadge = pgRefs > 0 ? ' (' + pgRefs + ')' : '';
        html += '<div class="page-item" data-page="' + pg.page + '" data-chapter="' + escapeAttr(ch.id) + '">p. ' + pg.page + refBadge + '</div>';
      }

      html += '</div></div>';
    }
    sidebarNav.innerHTML = html;
  }

  function renderStats() {
    let statsPanel = document.querySelector('.stats-panel');
    if (!statsPanel || !corpus) return;

    let types = corpus.entity_types;
    let html = '<h3>Detected References</h3>';
    for (let i = 0; i < types.length; i++) {
      let t = types[i];
      let count = corpus.stats.by_type[t.id] || 0;
      if (count > 0) {
        html += '<div class="stat-row">' +
          '<span class="stat-label"><span class="stat-dot" style="background:' + escapeAttr(t.color) + '"></span>' + escapeHtml(t.label) + '</span>' +
          '<span class="stat-value">' + count + '</span>' +
        '</div>';
      }
    }
    html += '<div class="stat-row" style="margin-top:8px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.08)">' +
      '<span class="stat-label">Total</span>' +
      '<span class="stat-value">' + corpus.stats.total_references + '</span>' +
    '</div>';
    statsPanel.innerHTML = html;
  }

  // ============================================================================
  // FILTERS
  // ============================================================================

  function renderFilters() {
    let filterBar = document.querySelector('.filter-bar');
    if (!filterBar || !corpus) return;

    let html = '<span class="filter-label">Entity type</span>';

    for (let i = 0; i < corpus.entity_types.length; i++) {
      let t = corpus.entity_types[i];
      let count = corpus.stats.by_type[t.id] || 0;
      if (count > 0) {
        let isActive = activeFilters.has(t.id);
        html += '<span class="filter-tag ' + (isActive ? 'active' : '') + '" data-type="' + escapeAttr(t.id) + '"><span class="dot"></span>' + escapeHtml(t.label) + ' (' + count + ')</span>';
      }
    }

    html += '<span class="filter-separator"></span><span class="filter-label">Confidence</span>';

    for (let j = 0; j < corpus.epistemic_types.length; j++) {
      let e = corpus.epistemic_types[j];
      let ecount = corpus.stats.by_epistemic[e.id] || 0;
      if (ecount > 0) {
        let eActive = activeEpistemicFilters.has(e.id);
        html += '<span class="filter-tag epistemic ' + (eActive ? 'active' : '') + '" data-epistemic="' + escapeAttr(e.id) + '"><span class="dot"></span>' + escapeHtml(e.label) + ' (' + ecount + ')</span>';
      }
    }

    filterBar.innerHTML = html;
  }

  // ============================================================================
  // CONTENT RENDERING
  // ============================================================================

  function renderWelcome() {
    closeRightPanel(false);
    rightPanelState.context = null;
    rightPanelState.dismissedByUser = false;
    rightPanelToggle.style.display = 'none';
    activeChapterId = null;
    backToDashboard.style.display = 'none';
    updateHash('');

    let stats = corpus.stats;
    let meta = corpus.metadata;

    // --- Summary stat cards ---
    let cardsHtml =
      '<div class="dashboard-stats">' +
        statCard(meta.pages_total, 'Pages scanned', 'var(--accent)') +
        statCard(stats.total_references, 'References found', '#e91e63') +
        statCard(stats.chapters, 'Chapters', '#00bcd4') +
        statCard(corpus.entity_types.length, 'Entity types', '#ff9800') +
      '</div>';

    // --- Pipeline status indicator ---
    var pipelineHtml = '<div class="pipeline-status">' +
      '<div class="pipeline-stage active"><span class="stage-icon">&#10003;</span>Rule-based<br>84 patterns</div>' +
      '<div class="pipeline-stage active"><span class="stage-icon">&#10003;</span>Abbreviation<br>dictionary</div>' +
      '<div class="pipeline-stage pending"><span class="stage-icon">&#9679;</span>Trie<br>matching</div>' +
      '<div class="pipeline-stage pending"><span class="stage-icon">&#9679;</span>CRF<br>sequence</div>' +
      '<div class="pipeline-stage pending"><span class="stage-icon">&#9679;</span>Structural<br>parsing</div>' +
      '<div class="pipeline-stage pending"><span class="stage-icon">&#9679;</span>Merge<br>consensus</div>' +
    '</div>';

    // --- CRF integration pending notice ---
    var crfNotice = '<div class="crf-notice">' +
      '<span class="notice-icon">&#9888;</span>' +
      '<div><strong>Rule-based detection only.</strong> ' +
      'This prototype currently shows results from Layer 1 (rule-based pattern matching) of the six-layer detection pipeline. ' +
      'CRF sequence labeling (Layer 4) is under development and will add machine-learned entity detection. ' +
      'Chapters showing no detected references may contain citations that require CRF or structural parsing to identify. ' +
      'Once multiple layers are active, annotations where methods agree will be marked with a <strong>Consensus</strong> badge.</div>' +
    '</div>';

    // --- Reference type bar chart ---
    let maxTypeCount = 0;
    for (let i = 0; i < corpus.entity_types.length; i++) {
      let c = stats.by_type[corpus.entity_types[i].id] || 0;
      if (c > maxTypeCount) maxTypeCount = c;
    }

    let typeChartHtml = '';
    for (let i = 0; i < corpus.entity_types.length; i++) {
      let t = corpus.entity_types[i];
      let count = stats.by_type[t.id] || 0;
      let pct = maxTypeCount > 0 ? (count / maxTypeCount * 100) : 0;
      typeChartHtml +=
        '<div class="bar-row">' +
          '<span class="bar-label">' + escapeHtml(t.label) + '</span>' +
          '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + escapeAttr(t.color) + '"></div></div>' +
          '<span class="bar-value">' + count + '</span>' +
        '</div>';
    }

    // --- Epistemic confidence bar chart ---
    let maxEpCount = 0;
    for (let i = 0; i < corpus.epistemic_types.length; i++) {
      let c = stats.by_epistemic[corpus.epistemic_types[i].id] || 0;
      if (c > maxEpCount) maxEpCount = c;
    }

    let epChartHtml = '';
    for (let i = 0; i < corpus.epistemic_types.length; i++) {
      let e = corpus.epistemic_types[i];
      let count = stats.by_epistemic[e.id] || 0;
      let pct = maxEpCount > 0 ? (count / maxEpCount * 100) : 0;
      epChartHtml +=
        '<div class="bar-row">' +
          '<span class="bar-label">' + escapeHtml(e.label) + '</span>' +
          '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + escapeAttr(e.color) + '"></div></div>' +
          '<span class="bar-value">' + count + '</span>' +
        '</div>';
    }

    // --- Chapter density heatmap ---
    let maxChRefs = 0;
    for (let i = 0; i < corpus.chapters.length; i++) {
      let rc = corpus.chapters[i].reference_counts;
      let total = 0;
      for (let k in rc) { if (rc.hasOwnProperty(k)) total += rc[k]; }
      if (total > maxChRefs) maxChRefs = total;
    }

    let heatmapHtml = '';
    for (let i = 0; i < corpus.chapters.length; i++) {
      let ch = corpus.chapters[i];
      let rc = ch.reference_counts;
      let total = 0;
      for (let k in rc) { if (rc.hasOwnProperty(k)) total += rc[k]; }

      let segHtml = '';
      if (total > 0) {
        for (let j = 0; j < corpus.entity_types.length; j++) {
          let t = corpus.entity_types[j];
          let c = rc[t.id] || 0;
          if (c > 0) {
            let segPct = maxChRefs > 0 ? (c / maxChRefs * 100) : 0;
            segHtml += '<div class="heatmap-segment" style="width:' + segPct + '%;background:' + escapeAttr(t.color) + '" title="' + escapeAttr(t.label + ': ' + c) + '"></div>';
          }
        }
      } else {
        segHtml = '<span class="heatmap-empty">rule-based: none &mdash; CRF pending</span>';
      }

      heatmapHtml +=
        '<div class="heatmap-row" data-chapter-id="' + escapeAttr(ch.id) + '">' +
          '<span class="heatmap-label">' + escapeHtml(ch.title) + '</span>' +
          '<div class="heatmap-track">' + segHtml + '</div>' +
          '<span class="heatmap-total">' + (total > 0 ? total : '\u2014') + '</span>' +
        '</div>';
    }

    // Legend for heatmap
    let legendHtml = '<div class="chart-legend">';
    for (let i = 0; i < corpus.entity_types.length; i++) {
      let t = corpus.entity_types[i];
      legendHtml += '<span class="legend-item"><span class="legend-dot" style="background:' + escapeAttr(t.color) + '"></span>' + escapeHtml(t.label) + '</span>';
    }
    legendHtml += '</div>';

    contentArea.innerHTML =
      '<div class="info-banner">' +
        '<h2>ITSERR-RESILIENCE Corpus Browser</h2>' +
        '<p>Exploring annotated 16th-century theological texts from the Kingdom of Hungary.</p>' +
        '<p>This prototype demonstrates <strong>rule-based entity detection</strong> (Stage 4, Layer 1 of the GNORM adaptation pipeline) applied to Leonard St\u00f6ckel\u2019s <em>Annotationes in Locos communes</em> (1561).</p>' +
        '<p style="margin-top:8px">' +
          '<span class="badge">Layer 1 \u2014 Rule-based detection</span> ' +
          '<span class="badge">Pre-CRF prototype</span> ' +
          (stats.consensus_count > 0
            ? '<span class="badge" style="background:rgba(33,150,243,0.1);color:#2196F3;">' + stats.consensus_count + ' consensus annotations</span> '
            : '') +
        '</p>' +
        (function() {
          var methodKeys = Object.keys(stats.by_method || {});
          if (methodKeys.length === 0) return '';
          return '<p style="margin-top:6px;font-size:12px;color:var(--text-muted);">Detection methods: ' +
            methodKeys.map(function(m) { return m + ' (' + stats.by_method[m] + ')'; }).join(', ') +
            '.</p>';
        })() +
        pipelineHtml +
        crfNotice +
      '</div>' +
      '<div class="dashboard">' +
        cardsHtml +
        '<div class="dashboard-charts">' +
          '<div class="chart-panel"><h3>Reference Types</h3>' + typeChartHtml + '</div>' +
          '<div class="chart-panel"><h3>Detection Confidence</h3>' + epChartHtml + '</div>' +
        '</div>' +
        '<div class="chart-panel full-width"><h3>Reference Density by Chapter</h3><p style="font-size:12px;color:var(--text-muted);margin:-8px 0 16px">Click a chapter to browse its annotated text</p>' + heatmapHtml + legendHtml + '</div>' +
      '</div>';

    // Make heatmap rows clickable
    contentArea.querySelectorAll('.heatmap-row[data-chapter-id]').forEach(function(row) {
      row.setAttribute('role', 'button');
      row.setAttribute('tabindex', '0');

      row.addEventListener('click', function() {
        renderChapter(row.dataset.chapterId);
      });

      row.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          renderChapter(row.dataset.chapterId);
        }
      });
    });
  }

  function statCard(value, label, color) {
    return '<div class="stat-card">' +
      '<div class="stat-number" style="color:' + escapeAttr(color) + '">' + escapeHtml(String(value)) + '</div>' +
      '<div class="stat-desc">' + escapeHtml(label) + '</div>' +
    '</div>';
  }

  function renderChapter(chapterId) {
    activeChapterId = chapterId;
    backToDashboard.style.display = '';
    updateHash(chapterId);

    let ch = null;
    for (let i = 0; i < corpus.chapters.length; i++) {
      if (corpus.chapters[i].id === chapterId) { ch = corpus.chapters[i]; break; }
    }
    if (!ch) return;

    // Update sidebar
    document.querySelectorAll('.chapter-item').forEach(function(el) {
      el.classList.toggle('active', el.dataset.chapter === chapterId);
      el.classList.toggle('expanded', el.dataset.chapter === chapterId);
    });
    document.querySelectorAll('.page-list').forEach(function(el) {
      el.classList.toggle('visible', el.parentElement.dataset.chapter === chapterId);
    });

    // Compute filtered ref counts
    let refCounts = {};
    for (let p = 0; p < ch.pages.length; p++) {
      let pg = ch.pages[p];
      for (let r = 0; r < pg.references.length; r++) {
        let ref = pg.references[r];
        if (activeFilters.has(ref.type) && activeEpistemicFilters.has(ref.epistemic)) {
          refCounts[ref.type] = (refCounts[ref.type] || 0) + 1;
        }
      }
    }

    let statsHtml = '';
    let types = Object.keys(refCounts);
    for (let ti = 0; ti < types.length; ti++) {
      let type = types[ti];
      let count = refCounts[type];
      let entityType = null;
      for (let ei = 0; ei < corpus.entity_types.length; ei++) {
        if (corpus.entity_types[ei].id === type) { entityType = corpus.entity_types[ei]; break; }
      }
      if (entityType) {
        statsHtml += '<span class="stat"><span class="dot" style="background:' + escapeAttr(entityType.color) + '"></span>' + escapeHtml(entityType.label) + ': ' + count + '</span>';
      }
    }

    let html =
      '<div class="chapter-header">' +
        '<h2>' + escapeHtml(ch.title) + '</h2>' +
        '<div class="chapter-en">' + escapeHtml(ch.title_en) + ' \u2014 Pages ' + ch.start_page + '\u2013' + ch.end_page + '</div>' +
        '<div class="chapter-stats">' + statsHtml + '</div>' +
      '</div>';

    if (ch.pages.length === 0) {
      html += '<div class="no-results">No content available for this chapter.</div>';
    } else {
      for (let pi = 0; pi < ch.pages.length; pi++) {
        html += renderPage(ch.pages[pi]);
      }
    }

    contentArea.innerHTML = html;
    contentArea.scrollTop = 0;

    // Open chapter summary in right panel (unless user dismissed it)
    if (!rightPanelState.dismissedByUser || rightPanelState.context === 'search') {
      openRightPanel('chapter-summary', ch);
    }
  }

  function renderPage(pg) {
    let annotatedText = applyAnnotations(pg.text, pg.references);
    return '<div class="page-block" id="page-' + pg.page + '">' +
      '<div class="page-label">Page ' + pg.page + '</div>' +
      '<div class="text-content">' + annotatedText + '</div>' +
    '</div>';
  }

  function applyAnnotations(text, references) {
    let filteredRefs = [];
    for (let i = 0; i < references.length; i++) {
      let r = references[i];
      if (activeFilters.has(r.type) && activeEpistemicFilters.has(r.epistemic)) {
        filteredRefs.push(r);
      }
    }

    if (filteredRefs.length === 0 && !searchQuery) {
      return escapeHtml(text);
    }

    let insertions = [];

    for (let fi = 0; fi < filteredRefs.length; fi++) {
      let ref = filteredRefs[fi];
      let idx = text.indexOf(ref.text, Math.max(0, ref.start - 10));
      if (idx === -1) continue;

      insertions.push({ pos: idx, end: idx + ref.text.length, type: 'ref-open', ref: ref });
      insertions.push({ pos: idx + ref.text.length, end: idx + ref.text.length, type: 'ref-close', ref: ref });
    }

    if (searchQuery && searchQuery.length >= 2) {
      let regex = new RegExp(escapeRegex(searchQuery), 'gi');
      let match;
      while ((match = regex.exec(text)) !== null) {
        insertions.push({ pos: match.index, end: match.index + match[0].length, type: 'search-open' });
        insertions.push({ pos: match.index + match[0].length, end: match.index + match[0].length, type: 'search-close' });
      }
    }

    insertions.sort(function(a, b) {
      if (a.pos !== b.pos) return a.pos - b.pos;
      let aOrder = a.type.indexOf('close') !== -1 ? 0 : 1;
      let bOrder = b.type.indexOf('close') !== -1 ? 0 : 1;
      return aOrder - bOrder;
    });

    let result = '';
    let lastIdx = 0;

    for (let ii = 0; ii < insertions.length; ii++) {
      let ins = insertions[ii];
      if (ins.pos > lastIdx) {
        result += escapeHtml(text.slice(lastIdx, ins.pos));
      }

      if (ins.type === 'ref-open') {
        let rr = ins.ref;
        let methods = rr.methods ? rr.methods.join(', ') : (rr.method || 'rule-based');
        let hasExplicitConsensus = (typeof rr.consensus === 'boolean');
        let isConsensus = hasExplicitConsensus ? rr.consensus : !!(rr.methods && rr.methods.length > 1);
        let consensusCls = isConsensus ? ' consensus-highlight' : '';
        result += '<span class="ref-highlight' + consensusCls + '" data-type="' + escapeAttr(rr.type) + '" data-confidence="' + escapeAttr(String(rr.confidence)) + '" data-epistemic="' + escapeAttr(rr.epistemic) + '" data-text="' + escapeAttr(rr.text) + '" data-method="' + escapeAttr(rr.method || methods) + '" data-methods="' + escapeAttr(methods) + '" data-consensus="' + escapeAttr(String(!!isConsensus)) + '">';
      } else if (ins.type === 'ref-close') {
        result += '</span>';
      } else if (ins.type === 'search-open') {
        result += '<span class="search-highlight">';
      } else if (ins.type === 'search-close') {
        result += '</span>';
      }

      lastIdx = ins.pos;
    }

    if (lastIdx < text.length) {
      result += escapeHtml(text.slice(lastIdx));
    }

    return result;
  }

  // ============================================================================
  // SEARCH
  // ============================================================================

  function performSearch(query) {
    searchQuery = query.trim();

    if (!searchQuery || searchQuery.length < 2) {
      searchCount.textContent = '';
      if (rightPanelState.context === 'search') closeRightPanel(false);
      if (activeChapterId) renderChapter(activeChapterId);
      return;
    }

    let regex = new RegExp(escapeRegex(searchQuery), 'gi');
    let totalMatches = 0;
    let chapterMatches = [];

    for (let i = 0; i < corpus.chapters.length; i++) {
      let ch = corpus.chapters[i];
      let chMatches = 0;
      for (let j = 0; j < ch.pages.length; j++) {
        let matches = ch.pages[j].text.match(regex);
        if (matches) chMatches += matches.length;
      }
      if (chMatches > 0) {
        totalMatches += chMatches;
        chapterMatches.push({ chapter: ch, count: chMatches });
      }
    }

    searchCount.textContent = totalMatches > 0
      ? totalMatches + ' match' + (totalMatches !== 1 ? 'es' : '') + ' in ' + chapterMatches.length + ' chapter' + (chapterMatches.length !== 1 ? 's' : '')
      : 'No matches';

    // Open search results in right panel
    if (chapterMatches.length > 0 && !rightPanelState.dismissedByUser) {
      openRightPanel('search', chapterMatches);
    } else if (chapterMatches.length === 0) {
      closeRightPanel(false);
    }

    if (activeChapterId) {
      renderChapter(activeChapterId);
    } else if (chapterMatches.length > 0) {
      renderSearchResults(chapterMatches, totalMatches);
    }
  }

  function renderSearchResults(chapterMatches, totalMatches) {
    let html =
      '<div class="info-banner">' +
        '<h2>Search Results: \u201c' + escapeHtml(searchQuery) + '\u201d</h2>' +
        '<p>' + totalMatches + ' matches found across ' + chapterMatches.length + ' chapters. Click a chapter to view the matches in context.</p>' +
      '</div>';

    for (let i = 0; i < chapterMatches.length; i++) {
      let chapter = chapterMatches[i].chapter;
      let count = chapterMatches[i].count;
      html += '<div class="page-block search-result" style="cursor:pointer" data-chapter-id="' + escapeAttr(chapter.id) + '">' +
        '<div class="page-label">' + escapeHtml(chapter.title) + ' \u2014 ' + escapeHtml(chapter.title_en) + ' (' + count + ' matches)</div>' +
      '</div>';
    }

    contentArea.innerHTML = html;

    contentArea.querySelectorAll('.search-result').forEach(function(block) {
      block.addEventListener('click', function() {
        let chapterId = block.dataset.chapterId;
        let navItem = document.querySelector('[data-chapter="' + chapterId + '"] .chapter-item');
        if (navItem) navItem.click();
      });
    });
  }

  // ============================================================================
  // TOOLTIP
  // ============================================================================

  function showTooltip(el, x, y) {
    let type = el.dataset.type;
    let confidence = el.dataset.confidence;
    let epistemic = el.dataset.epistemic;
    let text = el.dataset.text;
    let method = el.dataset.method;
    let methods = el.dataset.methods || method;
    let isConsensus = el.dataset.consensus === 'true';

    let entityType = null;
    for (let i = 0; i < corpus.entity_types.length; i++) {
      if (corpus.entity_types[i].id === type) { entityType = corpus.entity_types[i]; break; }
    }
    let typeLabel = entityType ? entityType.label : type;
    let typeColor = entityType ? entityType.color : '#999';

    let epistemicClass = epistemic === 'FACTUAL' ? 'factual' : (epistemic === 'DEFERRED' ? 'deferred' : 'interpretive');

    // Build "Detected by" method tags
    let methodList = parseMethodList(methods);
    let methodHtml = '';
    for (let mi = 0; mi < methodList.length; mi++) {
      methodHtml += '<span class="method-tag">' + escapeHtml(methodList[mi]) + '</span>';
    }

    let consensusHtml = isConsensus
      ? ' <span class="tooltip-badge consensus">Consensus</span>'
      : '';

    tooltip.innerHTML =
      '<div class="tooltip-type" style="color:' + escapeAttr(typeColor) + '">' + escapeHtml(typeLabel) + '</div>' +
      '<div class="tooltip-text">\u201c' + escapeHtml(text) + '\u201d</div>' +
      '<div class="tooltip-meta">' +
        '<span class="tooltip-badge ' + escapeAttr(epistemicClass) + '">' + escapeHtml(epistemic) + '</span>' +
        consensusHtml +
        '<span style="opacity:0.6;font-size:10px">Confidence: ' + Math.round(confidence * 100) + '%</span>' +
      '</div>' +
      '<div style="margin-top:4px;font-size:10px;opacity:0.7">Detected by: ' + methodHtml + '</div>';

    let maxX = window.innerWidth - 300;
    let maxY = window.innerHeight - 120;

    tooltip.style.left = Math.min(x + 12, maxX) + 'px';
    tooltip.style.top = Math.min(y + 12, maxY) + 'px';
    tooltip.classList.add('visible');
  }

  function hideTooltip() {
    tooltip.classList.remove('visible');
  }

  // ============================================================================
  // RIGHT PANEL
  // ============================================================================

  function openRightPanel(context, data) {
    rightPanelState.open = true;
    rightPanelState.context = context;
    rightPanelState.data = data;
    rightPanelState.dismissedByUser = false;

    rightPanel.classList.add('open');
    rightPanelToggle.style.display = 'none';

    let titles = { 'search': 'Search Results', 'reference': 'Reference Detail', 'chapter-summary': 'Chapter Summary' };
    rightPanelTitle.textContent = titles[context] || 'Details';

    if (context === 'search') renderRightPanelSearch(data);
    else if (context === 'reference') renderRightPanelReference(data);
    else if (context === 'chapter-summary') renderRightPanelChapterSummary(data);
  }

  function closeRightPanel(userDismissed) {
    rightPanelState.open = false;
    rightPanel.classList.remove('open');
    if (userDismissed) {
      rightPanelState.dismissedByUser = true;
      if (rightPanelState.context) rightPanelToggle.style.display = '';
    } else {
      rightPanelToggle.style.display = 'none';
    }
  }

  function toggleRightPanel() {
    if (rightPanelState.open) closeRightPanel(true);
    else if (rightPanelState.context) openRightPanel(rightPanelState.context, rightPanelState.data);
  }

  // --- Search results panel ---
  function renderRightPanelSearch(chapterMatches) {
    let html = '<div style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">' +
      'Chapters matching \u201c' + escapeHtml(searchQuery) + '\u201d</div>';

    for (let i = 0; i < chapterMatches.length; i++) {
      let cm = chapterMatches[i];
      let ch = cm.chapter;

      // Extract a snippet from the first matching page
      let snippet = '';
      let regex = new RegExp(escapeRegex(searchQuery), 'gi');
      for (let j = 0; j < ch.pages.length; j++) {
        let match = regex.exec(ch.pages[j].text);
        if (match) {
          let start = Math.max(0, match.index - 40);
          let end = Math.min(ch.pages[j].text.length, match.index + match[0].length + 60);
          snippet = (start > 0 ? '\u2026' : '') +
            ch.pages[j].text.slice(start, end).replace(/\n/g, ' ') +
            (end < ch.pages[j].text.length ? '\u2026' : '');
          break;
        }
      }

      html += '<div class="rp-search-chapter" data-chapter-id="' + escapeAttr(ch.id) + '">' +
        '<div class="rp-search-chapter-title">' + escapeHtml(ch.title) + '</div>' +
        '<div class="rp-search-chapter-count">' + cm.count + ' match' + (cm.count !== 1 ? 'es' : '') +
          ' \u00b7 pp.\u00a0' + ch.start_page + '\u2013' + ch.end_page + '</div>' +
        (snippet ? '<div class="rp-search-snippet">' + highlightSnippet(snippet, searchQuery) + '</div>' : '') +
      '</div>';
    }

    rightPanelBody.innerHTML = html;

    rightPanelBody.querySelectorAll('.rp-search-chapter').forEach(function(el) {
      el.setAttribute('role', 'button');
      el.setAttribute('tabindex', '0');
      el.addEventListener('click', function() { renderChapter(el.dataset.chapterId); });
      el.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          renderChapter(el.dataset.chapterId);
        }
      });
    });
  }

  function highlightSnippet(snippet, query) {
    if (!query) return escapeHtml(snippet);
    let regex = new RegExp(escapeRegex(query), 'gi');
    let result = '';
    let lastIndex = 0;
    let match;
    while ((match = regex.exec(snippet)) !== null) {
      result += escapeHtml(snippet.slice(lastIndex, match.index));
      result += '<mark class="search-highlight">' + escapeHtml(match[0]) + '</mark>';
      lastIndex = match.index + match[0].length;
    }
    result += escapeHtml(snippet.slice(lastIndex));
    return result;
  }

  // --- Reference detail panel ---
  function renderRightPanelReference(data) {
    let entityType = null;
    for (let i = 0; i < corpus.entity_types.length; i++) {
      if (corpus.entity_types[i].id === data.type) { entityType = corpus.entity_types[i]; break; }
    }
    let typeLabel = entityType ? entityType.label : data.type;
    let typeColor = entityType ? entityType.color : '#999';
    let typeDesc = entityType ? entityType.description : '';

    let epistemicType = null;
    for (let j = 0; j < corpus.epistemic_types.length; j++) {
      if (corpus.epistemic_types[j].id === data.epistemic) { epistemicType = corpus.epistemic_types[j]; break; }
    }

    // Build detected-by method tags and consensus badge for detail panel
    let detailMethods = data.methods || data.method || 'rule-based';
    let detailMethodList = parseMethodList(detailMethods);
    let detailMethodHtml = '';
    for (let dmi = 0; dmi < detailMethodList.length; dmi++) {
      detailMethodHtml += '<span class="method-tag">' + escapeHtml(detailMethodList[dmi]) + '</span>';
    }
    let detailConsensus = data.consensus === 'true' || data.consensus === true;
    let detailConsensusHtml = detailConsensus
      ? ' <span class="consensus-badge">Consensus</span>'
      : '';

    let html = '<div class="rp-section-title" style="color:' + escapeAttr(typeColor) + '">' + escapeHtml(typeLabel) + '</div>' +
      '<div class="rp-ref-text" style="border-left-color:' + escapeAttr(typeColor) + '">' + escapeHtml(data.text) + '</div>' +
      '<dl class="rp-meta">' +
        '<dt>Category</dt><dd>' + escapeHtml(typeDesc) + '</dd>' +
        '<dt>Confidence</dt><dd>' + Math.round(data.confidence * 100) + '% \u2014 ' +
          escapeHtml(data.epistemic) + (epistemicType ? ' (' + escapeHtml(epistemicType.description) + ')' : '') + '</dd>' +
        '<dt>Detected by</dt><dd>' + detailMethodHtml + detailConsensusHtml + '</dd>' +
        '<dt>Location</dt><dd>Page ' + escapeHtml(String(data.page)) + '</dd>' +
      '</dl>';

    // Related references of the same type in this chapter
    let ch = null;
    for (let ci = 0; ci < corpus.chapters.length; ci++) {
      if (corpus.chapters[ci].id === activeChapterId) { ch = corpus.chapters[ci]; break; }
    }
    if (ch) {
      let related = [];
      for (let pi = 0; pi < ch.pages.length; pi++) {
        let pg = ch.pages[pi];
        for (let ri = 0; ri < pg.references.length; ri++) {
          let ref = pg.references[ri];
          if (ref.text !== data.text && ref.type === data.type) {
            related.push({ text: ref.text, page: pg.page });
          }
        }
      }
      if (related.length > 0) {
        html += '<div style="margin-top:20px;"><div class="rp-section-title">Related in this chapter</div><ul class="rp-list">';
        for (let rr = 0; rr < related.length; rr++) {
          html += '<li class="rp-list-item" style="border-left-color:' + escapeAttr(typeColor) + ';cursor:default;">' +
            escapeHtml(related[rr].text) + ' <span style="color:var(--text-muted);font-size:11px">(p.\u00a0' + related[rr].page + ')</span></li>';
        }
        html += '</ul></div>';
      }

      // All references on this page
      let samePage = [];
      for (let sp = 0; sp < ch.pages.length; sp++) {
        if (String(ch.pages[sp].page) === String(data.page)) { samePage = ch.pages[sp].references; break; }
      }
      if (samePage.length > 1) {
        html += '<div style="margin-top:20px;"><div class="rp-section-title">All on page ' + escapeHtml(String(data.page)) + '</div><ul class="rp-list">';
        for (let ap = 0; ap < samePage.length; ap++) {
          let sr = samePage[ap];
          let srType = null;
          for (let sti = 0; sti < corpus.entity_types.length; sti++) {
            if (corpus.entity_types[sti].id === sr.type) { srType = corpus.entity_types[sti]; break; }
          }
          let srColor = srType ? srType.color : '#999';
          html += '<li class="rp-list-item" style="border-left-color:' + escapeAttr(srColor) + ';cursor:default;">' +
            escapeHtml(sr.text) + ' <span style="color:var(--text-muted);font-size:11px">(' + escapeHtml(srType ? srType.label : sr.type) + ')</span></li>';
        }
        html += '</ul></div>';
      }
    }

    rightPanelBody.innerHTML = html;
  }

  // --- Chapter summary panel ---
  function renderRightPanelChapterSummary(ch) {
    let html = '<div style="font-size:14px;font-weight:600;margin-bottom:4px;">' + escapeHtml(ch.title) + '</div>' +
      '<div style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">' +
        escapeHtml(ch.title_en) + ' \u2014 pp.\u00a0' + ch.start_page + '\u2013' + ch.end_page + '</div>';

    let rc = ch.reference_counts;
    let totalRefs = 0;
    for (let k in rc) { if (rc.hasOwnProperty(k)) totalRefs += rc[k]; }

    html += '<div class="rp-section-title">References by type</div>';
    if (totalRefs === 0) {
      html += '<div style="font-size:12px;color:var(--text-muted);padding:8px 0;">No references detected.</div>';
    } else {
      for (let i = 0; i < corpus.entity_types.length; i++) {
        let t = corpus.entity_types[i];
        let count = rc[t.id] || 0;
        if (count > 0) {
          html += '<div class="rp-stat-row">' +
            '<span style="display:flex;align-items:center;gap:6px;"><span class="dot" style="background:' + escapeAttr(t.color) + '"></span>' + escapeHtml(t.label) + '</span>' +
            '<span style="font-weight:600;">' + count + '</span></div>';
        }
      }
      html += '<div class="rp-stat-row" style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border-color);">' +
        '<span>Total</span><span style="font-weight:600;">' + totalRefs + '</span></div>';
    }

    html += '<div style="margin-top:20px;"><div class="rp-section-title">Pages</div>';
    for (let pi = 0; pi < ch.pages.length; pi++) {
      let pg = ch.pages[pi];
      let pgRefs = pg.references.length;
      html += '<div class="rp-list-item" data-page="' + pg.page + '" style="display:flex;justify-content:space-between;">' +
        '<span>Page ' + pg.page + '</span>' +
        '<span style="color:var(--text-muted);font-size:11px;">' + pgRefs + ' ref' + (pgRefs !== 1 ? 's' : '') + '</span></div>';
    }
    html += '</div>';

    rightPanelBody.innerHTML = html;

    // Page items scroll to that page in main content
    rightPanelBody.querySelectorAll('.rp-list-item[data-page]').forEach(function(el) {
      el.setAttribute('role', 'button');
      el.setAttribute('tabindex', '0');
      el.style.cursor = 'pointer';
      function scrollToPage() {
        let pageEl = document.getElementById('page-' + el.dataset.page);
        if (pageEl) pageEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      el.addEventListener('click', scrollToPage);
      el.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          scrollToPage();
        }
      });
    });
  }

  // ============================================================================
  // EVENTS
  // ============================================================================

  function bindEvents() {
    // --- Sidebar navigation ---
    sidebarNav.addEventListener('click', function (e) {
      let chapterItem = e.target.closest('.chapter-item');
      let pageItem = e.target.closest('.page-item');

      if (chapterItem) {
        renderChapter(chapterItem.dataset.chapter);
        closeMobileSidebar();
      } else if (pageItem) {
        let chId = pageItem.dataset.chapter;
        let pageNum = pageItem.dataset.page;
        if (activeChapterId !== chId) renderChapter(chId);
        closeMobileSidebar();
        setTimeout(function() {
          let pageEl = document.getElementById('page-' + pageNum);
          if (pageEl) {
            pageEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.querySelectorAll('.page-item').forEach(function(el) { el.classList.remove('active'); });
            pageItem.classList.add('active');
          }
        }, 50);
      }
    });

    // --- Search ---
    let searchTimeout;
    searchInput.addEventListener('input', function () {
      let self = this;
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(function() { performSearch(self.value); }, 250);
    });

    searchInput.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') { this.value = ''; performSearch(''); this.blur(); }
    });

    // --- Filters ---
    document.querySelector('.filter-bar').addEventListener('click', function (e) {
      let tag = e.target.closest('.filter-tag');
      if (!tag) return;

      if (tag.classList.contains('epistemic')) {
        let eid = tag.dataset.epistemic;
        if (activeEpistemicFilters.has(eid)) {
          if (activeEpistemicFilters.size > 1) activeEpistemicFilters.delete(eid);
        } else {
          activeEpistemicFilters.add(eid);
        }
      } else {
        let tid = tag.dataset.type;
        if (activeFilters.has(tid)) {
          if (activeFilters.size > 1) activeFilters.delete(tid);
        } else {
          activeFilters.add(tid);
        }
      }

      renderFilters();
      if (activeChapterId) renderChapter(activeChapterId);
    });

    // --- Tooltips ---
    contentArea.addEventListener('mouseover', function (e) {
      let ref = e.target.closest('.ref-highlight');
      if (ref) showTooltip(ref, e.clientX, e.clientY);
    });

    contentArea.addEventListener('mousemove', function (e) {
      let ref = e.target.closest('.ref-highlight');
      if (ref && tooltip.classList.contains('visible')) {
        let maxX = window.innerWidth - 300;
        let maxY = window.innerHeight - 120;
        tooltip.style.left = Math.min(e.clientX + 12, maxX) + 'px';
        tooltip.style.top = Math.min(e.clientY + 12, maxY) + 'px';
      }
    });

    contentArea.addEventListener('mouseout', function (e) {
      if (e.target.closest('.ref-highlight')) hideTooltip();
    });

    // --- Click reference to open detail ---
    contentArea.addEventListener('click', function (e) {
      let ref = e.target.closest('.ref-highlight');
      if (!ref) return;
      let pageBlock = ref.closest('.page-block');
      openRightPanel('reference', {
        type: ref.dataset.type,
        text: ref.dataset.text,
        confidence: parseFloat(ref.dataset.confidence),
        epistemic: ref.dataset.epistemic,
        method: ref.dataset.method,
        methods: ref.dataset.methods || ref.dataset.method,
        consensus: ref.dataset.consensus,
        page: pageBlock ? pageBlock.id.replace('page-', '') : '?'
      });
    });

    // --- Right panel controls ---
    document.getElementById('rightPanelClose').addEventListener('click', function () {
      closeRightPanel(true);
    });
    rightPanelToggle.addEventListener('click', function () {
      toggleRightPanel();
    });

    // --- Back to dashboard ---
    backToDashboard.addEventListener('click', function () {
      renderWelcome();
    });

    // --- Mobile sidebar ---
    sidebarToggle.addEventListener('click', function () {
      sidebarEl.classList.add('mobile-open');
      sidebarOverlay.classList.add('visible');
    });
    sidebarOverlay.addEventListener('click', closeMobileSidebar);

    // --- Export ---
    exportBtn.addEventListener('click', function (e) {
      e.stopPropagation();
      exportDropdown.classList.toggle('visible');
    });
    document.addEventListener('click', function (e) {
      if (!e.target.closest('#exportContainer')) {
        exportDropdown.classList.remove('visible');
      }
    });
    exportDropdown.querySelectorAll('.export-dropdown-item').forEach(function(item) {
      item.addEventListener('click', function () {
        exportDropdown.classList.remove('visible');
        exportData(item.dataset.format);
      });
    });

    // --- Keyboard shortcuts ---
    document.getElementById('helpBtn').addEventListener('click', function () {
      shortcutsOverlay.classList.add('visible');
    });
    document.getElementById('closeShortcuts').addEventListener('click', function () {
      shortcutsOverlay.classList.remove('visible');
    });
    shortcutsOverlay.addEventListener('click', function (e) {
      if (e.target === shortcutsOverlay) shortcutsOverlay.classList.remove('visible');
    });

    // --- Global keyboard shortcuts ---
    document.addEventListener('keydown', function (e) {
      // Ignore when typing in input fields
      var isInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';

      if (e.key === 'Escape') {
        if (shortcutsOverlay.classList.contains('visible')) {
          shortcutsOverlay.classList.remove('visible');
        } else if (rightPanelState.open) {
          closeRightPanel(true);
        } else if (sidebarEl.classList.contains('mobile-open')) {
          closeMobileSidebar();
        }
        return;
      }

      if (isInput) return;

      if (e.key === '/' || e.key === 'f' && (e.metaKey || e.ctrlKey)) {
        if (e.key === '/') e.preventDefault();
        searchInput.focus();
        return;
      }

      if (e.key === '?' && e.shiftKey) {
        shortcutsOverlay.classList.add('visible');
        return;
      }

      if (e.key === 'd' || e.key === 'D') {
        if (rightPanelState.open) closeRightPanel(true);
        else if (rightPanelState.context) openRightPanel(rightPanelState.context, rightPanelState.data);
        return;
      }

      if (e.key === 'Home') {
        e.preventDefault();
        if (corpus) renderWelcome();
        return;
      }

      // Arrow keys: navigate chapters
      if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
        if (!corpus) return;
        var currentIdx = -1;
        if (activeChapterId) {
          for (var ci = 0; ci < corpus.chapters.length; ci++) {
            if (corpus.chapters[ci].id === activeChapterId) { currentIdx = ci; break; }
          }
        }
        var nextIdx;
        if (e.key === 'ArrowRight') {
          nextIdx = currentIdx < corpus.chapters.length - 1 ? currentIdx + 1 : 0;
        } else {
          nextIdx = currentIdx > 0 ? currentIdx - 1 : corpus.chapters.length - 1;
        }
        renderChapter(corpus.chapters[nextIdx].id);
        return;
      }
    });

    // --- Hash navigation ---
    window.addEventListener('hashchange', handleHashNavigation);
  }

  // ============================================================================
  // MOBILE SIDEBAR
  // ============================================================================

  function closeMobileSidebar() {
    sidebarEl.classList.remove('mobile-open');
    sidebarOverlay.classList.remove('visible');
  }

  // ============================================================================
  // URL HASH NAVIGATION
  // ============================================================================

  function updateHash(chapterId) {
    if (chapterId) {
      history.replaceState(null, '', '#' + chapterId);
    } else {
      history.replaceState(null, '', window.location.pathname + window.location.search);
    }
  }

  function handleHashNavigation() {
    if (!corpus) return;
    var hash = window.location.hash.slice(1);
    if (!hash) return;

    for (var i = 0; i < corpus.chapters.length; i++) {
      if (corpus.chapters[i].id === hash) {
        renderChapter(hash);
        return;
      }
    }
  }

  // ============================================================================
  // EXPORT
  // ============================================================================

  function exportData(format) {
    if (!corpus) return;

    if (format === 'csv') {
      exportAllReferencesCSV();
    } else if (format === 'json') {
      exportAllReferencesJSON();
    } else if (format === 'chapter-csv') {
      if (!activeChapterId) {
        alert('No chapter selected. Navigate to a chapter first, or use "Export as CSV" for all references.');
        return;
      }
      exportChapterCSV(activeChapterId);
    }
  }

  function exportAllReferencesCSV() {
    var rows = [['Chapter', 'Chapter (English)', 'Page', 'Reference Text', 'Type', 'Epistemic', 'Confidence', 'Detection Method']];

    for (var ci = 0; ci < corpus.chapters.length; ci++) {
      var ch = corpus.chapters[ci];
      for (var pi = 0; pi < ch.pages.length; pi++) {
        var pg = ch.pages[pi];
        for (var ri = 0; ri < pg.references.length; ri++) {
          var ref = pg.references[ri];
          rows.push([
            ch.title, ch.title_en, String(pg.page),
            ref.text, ref.type, ref.epistemic,
            String(ref.confidence),
            ref.methods ? ref.methods.join('+') : (ref.method || 'rule-based')
          ]);
        }
      }
    }

    downloadCSV(rows, 'itserr_references_all.csv');
  }

  function exportChapterCSV(chapterId) {
    var ch = null;
    for (var i = 0; i < corpus.chapters.length; i++) {
      if (corpus.chapters[i].id === chapterId) { ch = corpus.chapters[i]; break; }
    }
    if (!ch) return;

    var rows = [['Page', 'Reference Text', 'Type', 'Epistemic', 'Confidence', 'Detection Method']];

    for (var pi = 0; pi < ch.pages.length; pi++) {
      var pg = ch.pages[pi];
      for (var ri = 0; ri < pg.references.length; ri++) {
        var ref = pg.references[ri];
        rows.push([
          String(pg.page), ref.text, ref.type, ref.epistemic,
          String(ref.confidence),
          ref.methods ? ref.methods.join('+') : (ref.method || 'rule-based')
        ]);
      }
    }

    var safeName = ch.title.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
    downloadCSV(rows, 'itserr_references_' + safeName + '.csv');
  }

  function exportAllReferencesJSON() {
    var data = {
      exported: new Date().toISOString(),
      source: corpus.metadata.title + ' by ' + corpus.metadata.author + ' (' + corpus.metadata.date + ')',
      pipeline: corpus.metadata.pipeline,
      total_references: corpus.stats.total_references,
      references: []
    };

    for (var ci = 0; ci < corpus.chapters.length; ci++) {
      var ch = corpus.chapters[ci];
      for (var pi = 0; pi < ch.pages.length; pi++) {
        var pg = ch.pages[pi];
        for (var ri = 0; ri < pg.references.length; ri++) {
          var ref = pg.references[ri];
          data.references.push({
            chapter: ch.title,
            chapter_en: ch.title_en,
            page: pg.page,
            text: ref.text,
            type: ref.type,
            epistemic: ref.epistemic,
            confidence: ref.confidence,
            method: ref.methods ? ref.methods.join('+') : (ref.method || 'rule-based'),
            consensus: ref.consensus || false
          });
        }
      }
    }

    var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    downloadBlob(blob, 'itserr_references.json');
  }

  function downloadCSV(rows, filename) {
    var csv = rows.map(function(row) {
      return row.map(function(cell) {
        var val = String(cell).replace(/"/g, '""');
        return '"' + val + '"';
      }).join(',');
    }).join('\n');

    // UTF-8 BOM for Excel compatibility
    var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    downloadBlob(blob, filename);
  }

  function downloadBlob(blob, filename) {
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ============================================================================
  // HELPERS
  // ============================================================================

  function escapeHtml(str) {
    let div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function escapeAttr(str) {
    return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function parseMethodList(str) {
    return str.split(/\s*[,+]\s*/).filter(Boolean);
  }

  // ============================================================================
  // BOOT
  // ============================================================================

  document.addEventListener('DOMContentLoaded', function () {
    sidebarNav = document.querySelector('.sidebar-nav');
    contentArea = document.querySelector('.content-area');
    searchInput = document.querySelector('.search-box input');
    searchCount = document.querySelector('.search-results-count');
    tooltip = document.querySelector('.ref-tooltip');
    rightPanel = document.getElementById('rightPanel');
    rightPanelBody = document.getElementById('rightPanelBody');
    rightPanelTitle = document.querySelector('.right-panel-title');
    rightPanelToggle = document.getElementById('rightPanelToggle');
    exportBtn = document.getElementById('exportBtn');
    exportDropdown = document.getElementById('exportDropdown');
    backToDashboard = document.getElementById('backToDashboard');
    sidebarEl = document.getElementById('sidebar');
    sidebarOverlay = document.getElementById('sidebarOverlay');
    sidebarToggle = document.getElementById('sidebarToggle');
    shortcutsOverlay = document.getElementById('shortcutsOverlay');
    loadingProgress = document.getElementById('loadingProgress');

    loadCorpus();
  });
})();
  </script>
</body>
</html>
